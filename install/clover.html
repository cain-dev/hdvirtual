<!DOCTYPE html>
<html lang="pt-BR" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Aprendendo sobre Secure Boot e TPM e como usar essas tecnologias no Linux.">
    <meta name="keywords" content="formata√ß√£o, windows, linux, freebsd, bios, uefi, instala√ß√£o, balena, etcher, ventoy, os">
    <meta name="author" content="Cain">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clover</title>
    <!--Social Media Open Graph-->
    <meta property="og:title" content="Instala√ß√£o de Sistemas Operacionais - Clover"/>
    <meta property="og:url" content="https://cain-dev.github.io/default/"/>
    <meta property="og:type" content="article"/>
    <meta property="og:description" content="Aprenda usar o Clover bootloader."/>
    <meta property="og:image" content="https://raw.githubusercontent.com/cain-dev/default/main/assets/images/ogimage.jpg"/>
    <!--/Social Media Open Graph-->
    <!--Links-->
    <link rel="shortcut icon" href="https://user-images.githubusercontent.com/6248794/164569238-e9372ecc-1534-4dda-a39b-fb86304ea7a5.png">
    <link rel="stylesheet" type="text/css"href="../os_style.css">   
    <!--/Links-->
</head>
<body>
    <header id="main-header">
        <ul>
            <li><a href="../index.html">Home</a></li>
            <li><p>@cain-dev</p></li>
            <li><a href="../extra/contact.html">Contato</a></li>
        </ul>
    </header>
    <main id="main-area">
        <h1>Clover</h1>
        <!-- INTRODU√á√ÉO -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Introdu√ß√£o</h2>
        <p>O Clover √© um bootloader originalmente desenvolvido para inicializar Hackintoshes, √© um projeto j√° muito maduro e que disponibiliza bin√°rios para diversos tipos de solu√ß√µes, po≈ïem um dos grandes diferenciais do Clover √© a capacidade de emular o UEFI em sistemas de legado... <em>Isso mesmo que voc√™ leu!</em> Emular as capacidades do UEFI em sistemas de legado! Obviamente eu n√£o recomendo isso para novatos por ser uma implementa√ß√£o de baixo n√≠vel e n√£o ser t√£o est√°vel quanto usar em BIOS um sistema instalado em um computador que tem BIOS... Mas √© uma alternativa bastante interessante.</p>
        <p>√â bom avisar de antem√£o que o sucesso nessa implementa√ß√£o depende largamente da vers√£o do Clover, dos loaders utilizados, e da compatibilidade dessa vers√£o com a sua placa m√£e. E certamente n√£o √© compat√≠vel com todos os casos, e ela quase nunca vai ser compat√≠vel com virtualiza√ß√£o (o que tamb√©m seria in√∫til de ser utilizado em virtualiza√ß√µes mas tudo bem).</p>
        <!-- PREPARA√á√ÉO DA INSTALA√á√ÉO -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Instala√ß√£o (UEFI simulada em BIOS)</h2>
        <p>Eu te recomendo fortemente a fazer esse procedimento atrav√©s de uma conex√£o SSH, voc√™ pode at√© mesmo fazer esse procedimento preparando o disco via terminal para um outro computador, ent√£o n√£o se limite a fazer isso no computador alvo. </p>
        <p>Antes de mais nada precisamos da ISO do Clover, voc√™ pode come√ßar baixando a ISO do Clover atrav√©s desse link <a class="link" href="https://github.com/CloverHackyColor/CloverBootloader/releases">aqui</a> e preparando em um outro pendrive, ou mesmo colocando ela em um drive de CD (real ou virtual), e caso esteja dentro de um sistema live com suporte a <em>git</em> e <em>curl</em> pode usar o comando abaixo para baixar para seu pwd:</p>
        <code>curl -L -O $(curl -s https://api.github.com/repos/CloverHackyColor/CloverBootloader/releases/latest | grep -o 'https://github.com/CloverHackyColor/CloverBootloader/releases/download/[^"]*/Clover-.*-X64.iso.7z')</code>
        <p>Se voc√™ baixou o pacote ao inv√©s de usar a ISO, extraia a ISO atrav√©s do pacote <em>7zip</em> com o comando:</p>
        <code>7z x Clover-*-X64.iso.7z</code>
        <p>Com a ISO e diret√≥rio prontos monte a ISO com o comando:</p>
        <code>mount --mkdir -o loop Clover-*-X64.iso /mnt/iso</code>
        <p>E caso tenha essa ISO em outro disco, seja numa m√°quina real ou virtual pode montar com o comando:</p>
        <code>mount --mkdir -t iso9660 /dev/sr0 /mnt/iso</code>
        <p>√â bom lembrar que o Clover presume um layout de disco <em>UEFI/GPT</em>, a √∫nica diferen√ßa √© que a a flag <em>"Legacy BIOS bootable"</em> deve ser marcada para a ESP. Ent√£o, vamos criar uma ESP v√°lida para o Clover usando o GDISK:</p>
        <!-- Passo 4 Op√ß√£o B - armazenamento em sistemas baseados em UEFI -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h3>Prepara√ß√£o para armazenamento em sistemas baseados em <mark>UEFI</mark></h3>
        <p>Caso queira limpar a tabela de parti√ß√£o desse dispositivo (<strong>Leia-se apagar tudo!</strong>) pode usar o comando abaixo:</p>
        <code>sgdisk -Z /dev/<mark>storageA</mark></code>
        <p>Para particionar o disco utilizaremos a ferramenta <em>gdisk</em> na unidade desejada, para isso utilize o comando:</p>
        <code>gdisk /dev/<mark>storageA</mark></code>
        <p>Com o <mark>gdisk</mark> aberto na unidade desejada criaremos uma nova tabela de parti√ß√£o em <mark>GPT</mark> com o comando:</p>
        <code>o</code>
        <!-- Modo Normal GDISK ESP -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->  
        <h3>Parti√ß√£o <em>ESP</em> (EFI system partition)</h3>
        <p>Para uma instala√ß√£o de sistema em modo UEFI precisamos criar uma parti√ß√£o <em>ESP</em>, que √© uma parti√ß√£o espec√≠fica para ser acessada pela placa m√£e para iniciar os sistemas. Para criar a parti√ß√£o <em>ESP</em> use o comando:</p>
        <code>n</code>
        <p>O sistema ir√° exibir a seguinte linha para que voc√™ escolha o n√∫mero da parti√ß√£o:</p>
        <code>partition number: default</code>
        <p>Apenas tecle <mark>Enter</mark>.</p>
        <p>Logo em seguida o sistema ir√° exibir a seguinte linha para que voc√™ escolha o ponto de in√≠cio da parti√ß√£o:</p>
        <code>first sector: default</code>
        <p>Apenas tecle <mark>Enter</mark>.</p>
        <p>Logo em seguida o sistema ir√° exibir a linha abaixo para que voc√™ escolha o ponto de t√©rmino da parti√ß√£o e delimite o seu tamanho, por quest√µes de compatibilidade recomendo <mark>550M</mark>, sendo assim deveremos utilizar o comando <mark>+550M</mark> e teclar <mark>Enter</mark>, de maneira que o di√°logo no terminal fique da seguinte forma:</p>
        <code>last sector: +550M</code>
        <p>Logo em seguida o sistema ir√° exibir a linha abaixo para que voc√™ escolha o tipo da parti√ß√£o, para o tipo <mark>ESP</mark> devemos digitar o tipo <mark>ef00</mark> e teclar <mark>Enter</mark> de maneira que o di√°logo no terminal fique da seguinte forma:</p>
        <code>Hex code or GUID (L to show codes, Enter = 8300): ef00</code>
        <p>Com isso temos uma parti√ß√£o no in√≠cio do armazenamento, de 550M e do tipo EFI system partition.</p>
        <!-- Modo Normal GDISK ESP -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->  
        <h3>Adi√ß√£o de atributos na ESP</h3>
        <p>Assim que retornar a tela de inser√ß√£o de comandos (<em>Command (? for help):</em>), vamos acessar as op√ß√µes avan√ßacas de recovery com o comando <em>r</em>:</p>
        <code>r recovery and transformation options (experts only)</code>
        <p>Acessar o menu de funcionalidade extra com o comando <em>x</em>:</p>
        <code>x extra funcionality (experts only)</code>
        <p>Agora vamos setar o atributo <em>Legacy BIOS bootable</em> com o comando <em>a</em> (caso pergunte, informe o n√∫mero da parti√ß√£o ESP):</p>
        <code>a set attributes</code>
        <p>E vamos inserir a op√ß√£o <em>2</em>:</p>
        <code>2: legacy BIOS bootable</code>
        <p>Como n√£o h√° mais nenhum atributo para ser inserido, apenas tecle <em>Enter</em> e depois insira o comando <em>w</em> para gravar as altera√ß√µes.</p>
        <p>Caso esteja usando o <em>Parted</em> voc√™ pode usar o comando abaixo para deixar a parti√ß√£o com o atributo <em>legacy BIOS bootable</em> ativo:</p>
        <code>sudo parted /dev/<mark>storageAP1</mark> set 1 legacy_boot on</code>
        <p>Caso queira verificar a flag com o GDISK, acesse as op√ß√µes avan√ßacas de recovery com o comando <em>r</em>:</p>
        <code>r recovery and transformation options (experts only)</code>
        <p>Em seguida acesse as informa√ß√µes detalhadas da parti√ß√£o com o comando <em>i</em>, e informe o n√∫mero da parti√ß√£o caso perguntado:</p>
        <code>i show detailed information on a partition</code>
        <p>Se o o campo de atributos estiver como no exemplo abaixo est√° correto:</p>
        <code>Attribute flags: 0000000000000004</code>
        <p>Caso esteja dessa outra forma, insira a flag:</p>
        <code>Attribute flags: 0000000000000000</code>
        <p>Caso queira usar o Parted para isso pode usar o comando:</p>
        <code>sudo parted /dev/<mark>storageA</mark> print</code>
        <p>E na se√ß√£o flag voc√™ poder√° ver a flag <em>legacy_boot</em>.</p>
        <!-- Passo 5 - Formatar as parti√ß√µes ESP e XBOOTLDR-->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h3>Formatando a parti√ß√£o <em>ESP</em></strong> </h3>
        <p>Por padr√£o √© formatada em <mark>FAT32</mark>... Mas para esse caso espec√≠fico, considerando que n√£o estamos lidando com uma placa m√£e com todas as padroniza√ß√µes garantidas para um UEFI nativo, a parti√ß√£o <mark>ESP</mark> varia conforma o suporte da sua placa m√£e, as chances s√£o que ela <em>AINDA</em> deve ser em <mark>FAT32</mark>, mas pode ser por exemplo <mark>exFAT</mark> ou talvez at√© <mark>HFS</mark> para um Mac real. Se abrir a pasta <mark>BootSectors</mark> do seu Clover vai achar arquivos de suporte para <mark>HFS</mark>, <mark>FAT32</mark> e <mark>exFAT</mark> (e at√© varia√ß√µes desses arquivos para redirecionamento de boot), fique a vontade pare tentar com eles (e recomendo que voc√™ veja a descri√ß√£o de cada um na documenta√ß√£o). Mas supondo que por acaso a sua parti√ß√£o <mark>ESP</mark> √© a <mark>/dev/storageAP1</mark>, utilize o comando abaixo para formatar a parti√ß√£o substituindo o <mark>/dev/storageAP1</mark> para o devido endere√ßo da parti√ß√£o <mark>ESP</mark> no seu dispositivo:</p>
        <code>mkfs.fat -F32 /dev/<mark>storageAP1</mark></code>
        <details class="spoiler" >
            <summary>Formata√ß√£o avan√ßada (Clique para ver)</summary>
            <p>Diferentes sistemas de arquivo (e at√© mesmo ferramentas) podem ter por padr√£o o uso de tamanhos distintos de setor. Caso voc√™ queira especificar o tamanho do setor utilize o argumento <em>-S</em> como no exemplo abaixo:</p>
            <code>mkfs.fat -F 32 <em>-S 4096</em> /dev/<mark>storageAP1</mark></code>
            <p>Embora n√£o seja estritamente necess√°rio, √© recomendado o uso de r√≥tulos para identificar as parti√ß√µes para o caso de voc√™ n√£o ter em mente nenhum outro identificador. Caso voc√™ queira especificar o r√≥tulo da parti√ß√£o adicione o argumento <em>-n</em> seguido do "<em>ROTULO</em>" como no exemplo abaixo:</p>
            <code>mkfs.fat -F 32 <em>-n "ESP"</em> /dev/<mark>storageAP1</mark></code>
        </details>        
        <h4>Descri√ß√£o das <i>Master Boot Records</i></h4>
        <p>Segue abaixo as descri√ß√µes dos loaders de est√°gio 1:</p>
        <ul>
            <li><p><em>boot0af (boot0 Active First)</em> - Setor MBR que busca a parti√ß√£o ativa na tabela MBR (e depois na tabela GPT). Originado do projeto boot132 da Apple. Esta vers√£o do boot0af implementa suporte ao esquema h√≠brido de parti√ß√µes GUID/MBR. Escrito por Tam√°s Kos√°rszky em 10/03/2008;</p></li>
            <li><p><em>boot0ss (boot0 Signature Scanning)</em> - Setor MBR que busca por qualquer parti√ß√£o com uma assinatura PBR v√°lida, independentemente de estar ativa ou n√£o. √ötil para o Windows, que exige que sua parti√ß√£o esteja ativa. Compartilha o mesmo c√≥digo do boot0af, mas a ordem de busca √© diferente. Escrito por JrCs em 08/05/2013;</p></li>
            <li><p><em>boot0md (boot0 Multiple Drives)</em> - Setor MBR que busca por todos os discos e busca por uma parti√ß√£o inicializ√°vel (com boot1h) e a carrega, se n√£o for encontrada, itera sobre os discos novamente e busca por uma parti√ß√£o ativa e a carrega;</p></li>
        </ul>
        <h4>Descri√ß√£o das <i>Partition Boot Records</i></h4>
        <p>Segue abaixo as descri√ß√µes dos loaders de est√°gio 2:</p>
        <ul>
            <li><p><em>boot1h</em> - Setor PBR para parti√ß√£o formatada em <em>HFS+</em>. Procura pelo arquivo <i>"boot"</i> na raiz da parti√ß√£o. Originado do projeto <em>boot132</em> da Apple. Escrito por Tam√°s Kos√°rszky em 14/04/2008. Modificado por Slice para suportar arquivos de boot maiores. <strong>N√£o mais 440 KB como a vers√£o original</strong>, mas <em>472 KB</em> necess√°rios para inicializar o Clover-64;</p></li>
            <li><p><em>boot1h2</em> - Setor PBR para parti√ß√£o <em>HFS+</em>, com boot alternativo baseado na tecla pressionada. Arquivo para inicializar = "boot{key}". Codificado por dmazar com base no <em>boot1h</em>;</p></li>
            <li><p><em>boot1f32</em> - Setor PBR para parti√ß√£o formatada em <em>FAT32</em>. Procura pelo arquivo "boot" na raiz da parti√ß√£o. √ötil para parti√ß√µes EFI ou pendrive. Escrito por mackerintel em 26/01/2009;</p></li>
            <li><p><em>boot1f32alt</em> - Setor PBR para parti√ß√£o <em>FAT32</em>, com boot alternativo baseado na tecla pressionada. Arquivo para inicializar = "boot{key}". Modificado por Slice com base no <em>boot1f32</em> e <em>boot1h2</em>;</p></li>
            <li><p><em>boot1x</em> - Setor PBR para parti√ß√£o formatada em <em>exFAT</em>. Procura pelo arquivo "boot" na raiz da parti√ß√£o. √ötil para parti√ß√µes EFI ou pendrive. Escrito por Zenith432 em 19/11/2014;</p></li>
        </ul>
        <h4>Descri√ß√£o das <i>Partition Boot Records</i></h4>
        <p>Segue abaixo as descri√ß√µes dos loaders de est√°gio 3:</p>
        <ul>
            <li><p><em>boot6</em> - CloverEFI 64 bits - Com driver ATA/ATAPI pr√≥prio;</p></li>
            <li><p><em>boot7</em> - CloverEFI 64 bits (padr√£o) - Inclui um driver BiosBlockIO que funciona com qualquer controlador compat√≠vel com o BIOS. √ötil para implementa√ß√µes bugadas de BIOS ou para uso de RAID;</p></li>
        </ul>
        <!-- Preparando o disco para o Clover -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->  
        <h3>Preparando o disco para o Clover</h3>
        <p>Vamos come√ßar com uma c√≥pia do primeiro setor da parti√ß√£o <em>ESP</em> (Partition Boot Record) e armazenar no diret√≥rio <mark>/tmp/original_PBR</mark>:</p>
        <code>dd if=/dev/<mark>storageAP1</mark> of=/tmp/original_PBR bs=512 count=1 conv=notrunc</code>
        <p>Vai resultar em usa sa√≠da como:</p>
        <code>1+0 records in<br>1+0 records out<br>512 bytes copied</code>
        <p>Agora vamos copiar o arquivo <mark>/mnt/iso/usr/standalone/i386/boot1f32</mark> para <mark>/tmp/new_PBR</mark>:</p>
        <code>cp /mnt/iso/usr/standalone/i386/boot1f32 /tmp/new_PBR</code>
        <p>Agora vamos copiar exatos <em>87 bytes</em> da Partition Boot Record original para a nova Partition Boot Record:</p>
        <code>dd if=/tmp/original_PBR of=/tmp/new_PBR skip=3 seek=3 bs=1 count=87 conv=notrunc</code>
        <p>Vai resultar em usa sa√≠da como:</p>
        <code>87+0 records in<br>87+0 records out<br>87 bytes copied</code>
        <p>Agora vamos regravar a nossa Partition Boot Record do disco com esse novo arquivo rec√©m gerado:</p>
        <code>dd if=/tmp/new_PBR of=/dev/<mark>storageAP1</mark> bs=512 count=1 conv=notrunc</code>
        <p>Vai resultar em usa sa√≠da como:</p>
        <code>1+0 records in<br>1+0 records out<br>512 bytes copied</code>
        <p>E agora vamos gravar a nossa Master Boot Record com o <em>BOOT0</em> do arquivo <em>boot0ss</em>:</p>
        <code>dd if=/mnt/iso/usr/standalone/i386/boot0ss of=/dev/<mark>storageA</mark> bs=440 count=1 conv=notrunc</code>
        <p>Vai resultar em usa sa√≠da como:</p>
        <code>1+0 records in<br>1+0 records out<br>440 bytes copied</code>
        <!--
        <p>Ap√≥s isso copie o diret√≥rio <em>/mnt/iso/efi</em> para sua <em>ESP</em></p>
        <p>Copie o legacy boot loader para a EFI System partition</p>
        <code>cp /mnt/iso/usr/standalone/i386/x64/boot6 /boot/boot</code>
        -->
        <!-- Instalando o Clover no disco -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h3>Instalando o Clover no disco</h3>
        <p>Para desencargo de consci√™ncia vamos montar a parti√ß√£o <em>ESP</em> como <em>/mnt/efi</em>:</p>
        <code>mount --mkdir /dev/<em>storageAP1</em> /mnt/efi</code>
        <p>Agora vamos copiar os arquivos do Clover para a parti√ß√£o ESP:</p>
        <code>cp -r /mnt/iso/efi /mnt/efi/</code>
        <code>cp /mnt/iso/usr/standalone/i386/x64/boot6 /mnt/efi/boot</code>
        <p>Por fim demonte as parti√ß√µes com o comando:</p>
        <code>umount /mnt/efi /mnt/iso</code>
    </main>
    <footer id="main-footer">
        <p>Est√° p√°gina ainda est√° em constru√ß√£o üöß</p>
        <a class="footerlink" href="#main-header">‚Üë Retornar ao topo ‚Üë</a>
    </footer>
</body>
</html>