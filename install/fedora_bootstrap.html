<!DOCTYPE html>
<html lang="pt-BR" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta name="keywords" content="formata√ß√£o, windows, linux, freebsd, bios, uefi, instala√ß√£o, balena, etcher, ventoy, os">
    <meta name="author" content="Cain">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instala√ß√£o do Fedora Bootstrap</title>
    <!--Social Media Open Graph-->
    <meta property="og:title" content="Instala√ß√£o de Sistemas Operacionais - Fedora Bootstrap"/>
    <meta property="og:url" content="https://cain-dev.github.io/default/"/>
    <meta property="og:type" content="article"/>
    <meta property="og:description" content="Aprenda a instalar Fedora na unha, excelente para programadores."/>
    <meta property="og:image" content="https://raw.githubusercontent.com/cain-dev/default/main/assets/images/ogimage.jpg"/>
    <!--/Social Media Open Graph-->
    <!--Links-->
    <link rel="shortcut icon" href="https://fedoraproject.org/favicon.ico">
    <link rel="stylesheet" type="text/css"href="../os_style.css">   
    <!--/Links-->
</head>
<body>
    <header id="main-header">
        <ul>
            <li><a href="../index.html">Home</a></li>
            <li><p>@cain-dev</p></li>
            <li><a href="../extra/contact.html">Contato</a></li>
        </ul>
    </header>
    <main id="main-area">
        <h1>Instala√ß√£o do Fedora bootstrap</h1>
        <p><strong>Aten√ß√£o!Isso ainda √© um rascunho da documenta√ß√£o final!</strong></p>
        <!-- INTRODU√á√ÉO -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Introdu√ß√£o</h2>
        <p>Quando o assunto √© "instala o Linux e deixa arder" existem 3 distribui√ß√µes que se destacam: O Ubuntu, o Debian e o CentOS. O Ubuntu j√° foi excelente devido aos esfor√ßos da Canonical, mas hoje ele sofre bastante devido aos... Esfor√ßos da Canonical... Uma melhor alternativa seria o Debian, por√©m, a verdade √© que para alguns usos o Debian tem pacotes jur√°ssicos, e o CentOS foi meio que "assassinado" pela IBM. Ent√£o se voc√™ √© um programador que quer manter os boletos e customiza√ß√£o em dia o que te sobra √© o Fedora meu amigo.</p>
        <p>O Fedora √© uma distro bem atualizada e s√≥lida, por√©m seguindo o instalador da distro (o Anaconda se n√£o me engano) √© simplesmente insuficiente para quem quer alguma customiza√ß√£o mais profunda, por√©m assim como o Arch (na verdade assim como qualquer Linux ou BSD üòÇ) o Fedora tamb√©m pode ser instalado comando a comando (o famoso boostrap). Ent√£o vamos a isso!</p>
        <!-- PREPARA√á√ÉO DA INSTALA√á√ÉO -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Instala√ß√£o</h2>
        <p>Inicie o Fedora em live normalmente, fa√ßa as devidas configura√ß√µes de resolu√ß√£o e teclado, internet e energia (inclusive eu altamente recomendo desabilitar a suspen√ß√£o e desligamento de tela) e abra um terminal para come√ßar a instala√ß√£o e use o comando abaixo para se tornar administrador:</p>
        <code>sudo -s</code>
        <p>Mas caso voc√™ tenha uma carro√ßa e o Gnome seja pesado demais voc√™ pode...</p>
        <h3>(Opcional) Iniciar o Fedora em modo texto:</h3>
        <p>Na tela de sele√ß√£o de sistema do GRUB2 tecle <em>e</em>, ao final da linha que come√ßa com <em>linux</em> adicione:</p>
        <code>systemd.unit=multi-user.target</code>
        <p>E por fim tecle <em>F10</em> para inicializar o Fedora em "modo texto".</p>
        <p>Se subir o terminal e pedir o nome de usu√°rio, utilize <em>root</em>.</p>
        <p>Para deixar o teclado em abnt2 use o comando:</p>
        <code>loadkeys br-abnt2</code>
        <p>Eu recomendo a instala√ß√£o atrav√©s de cabo de rede, mas caso queira se conectar no wifi pode usar o comando abaixo para listar as redes:</p>
        <code>nmcli dev wifi list</code>
        <p>Conecte-se na sua rede usando o comando abaixo:</p>
        <code>nmcli dev wifi connect <em>SSID</em> password <em>senha</em> </code>
        <p>Se a rede n√£o possui senha, voc√™ deve omitir o campo <em>password</em>, como no exemplo abaixo:</p>
        <code>nmcli dev wifi connect <em>SSID</em></code>
        <p>Se aparecer <i>Device wlp1s0 successfully activated with...</i> ou algo do tipo voc√™ est√° conectado, caso queira verificar o estado da conex√£o use o comando:</p>
        <code>nmcli connection show</code>
        <p>J√° com acesso a internet e ambiente configurado, deixe o SELinux em modo permissivo para evitar dor de cabe√ßa:</p>
        <code>setenforce 0</code>
        <!-- PARTICIONAMENTO DE DISCOS -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Particionamento de disco</h2>
        <p><strong>PS:</strong> Aqui eu recomendo que voc√™ v√° ver o guia para a instala√ß√£o do Arch nas se√ß√µes de particionamento e formata√ß√£o das parti√ß√µes, vou seguir este tutorial como refer√™ncia simples de um sistema que utiliza BTRFS para raiz, mas fique a vontade para mudar conforme a sua necessidade üëç.</p>
        <p>Comece instalando o gdisk com o comando:</p>
        <code>dnf install gdisk -y</code>
        <p>Voc√™ pode verificar as tabelas de parti√ß√£o da unidade de armazenamento com o comando:</p>
        <code>sgdisk -p /dev/<mark>storageA</mark></code>
        <p>Caso queira limpar a tabela de parti√ß√£o desse dispositivo (<strong>Leia-se apagar tudo!</strong>) pode usar o comando abaixo:</p>
        <code>sgdisk -Z /dev/<mark>storageA</mark>, ap√≥s isso use o <em>gdisk</em> para fazer as devidas altera√ß√µes.</code>
        <p>Para atualizar as informa√ß√µes de particionamento para o sistema use o comando:</p>
        <code>partprobe -s /dev/<mark>storageA</mark></code>
        <!-- (OPCIONAL) CRIPTOGRAFAR PARTI√á√ïES -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>(Opcional) Criptografar as parti√ß√µes</h2>
        <details class="spoiler" >
            <summary>Preparando as parti√ß√µes</summary>
            <p>Voc√™ precisa preparar de antem√£o um dispositivo de abstra√ß√£o para as parti√ß√µes que deseja criptografar, pois a parti√ß√£o n√£o vai ser formatada diretamente e sim atrav√©s do LUKS! Ent√£o antes de qualquer outra coisa vamos gerar um arquivo de senha no diret√≥rio atual (escolha uma das op√ß√µes abaixo):</p>
            <code>openssl rand -base64 32 > cryptroot.key</code>
            <code>openssl rand -hex 32 > cryptroot.key</code>
            <p>Esse comando usa o OpenSSL para gerar uma <i>string</i> rand√¥mica, do tipo base64 ou hex com 32 bytes e exporta para um arquivo com o nome de <em>cryptroot.key</em>.</p>
            <p>Agora vamos criptografar a parti√ß√£o desejada usando o LUKS:</p>
            <code>cryptsetup luksFormat --type luks2 /dev/<mark>storageAP4</mark> --key-file cryptroot.key</code>
            <p>Agora vamos abrir essa parti√ß√£o atrav√©s do LUKS para gerar uma abstra√ß√£o da parti√ß√£o com o nome de <em>cryptroot</em>:</p>
            <code>cryptsetup luksOpen /dev/<mark>storageAP3</mark> <em>cryptroot</em> --key-file cryptroot.key</code>
            <p>Uma vez que o dispotivo foi aberto, ele criar√° um dispositivo /dev/mapper/<em>cryptroot</em>, vamos ent√£o formatar essa abstra√ß√£o (e n√£o o dispositivo em si!) mapeada pelo LUKS:</p>
            <p><strong>Embora aqui esteja sendo formatado em btrfs, mude conforme a sua necessidade!</strong></p>
            <code>mkfs.btrfs -f -L <em>"ROOT"</em> /dev/mapper/<em>cryptroot</em></code>
            <p>Quando for montar essa parti√ß√£o, use o comando abaixo ao inv√©s de montar algo como /dev/<mark>storageAP3</mark>:</p>
            <code>mount /dev/mapper/<em>cryptroot</em> /mnt</code>
            <p>Uma vez montada, voc√™ pode interagir com essa parti√ß√£o normalmente! Inclusive agora <strong>DEVE</strong> copiar o arquivo chave contendo a senha para /mnt:</p>
            <code>cp cryptroot.key /mnt/cryptroot.key</code>
        </details>
        <!-- Formatar as parti√ß√µes -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h3>Formatando a parti√ß√£o root em BTRFS</h3>
        <p>A parti√ß√£o raiz do sistema <em>/</em> ser√° formatada em <mark>BTRFS</mark>. Considerando que elas est√£o no endere√ßo <mark>/dev/storageAP3</mark> utilize o comando abaixo para format√°-la:</p>
        <code>mkfs.btrfs /dev/<mark>storageAP3</mark></code>
        <details class="spoiler" >
            <summary>Formata√ß√£o avan√ßada (Clique para ver)</summary>
            <p>Diferentes sistemas de arquivo (e at√© mesmo ferramentas) podem ter por padr√£o o uso de tamanhos distintos de setor. Caso voc√™ queira especificar o tamanho do setor utilize o argumento <em>-s</em> como no exemplo abaixo:</p>
            <code>mkfs.btrfs  <em>-s 4096</em> /dev/<mark>storageAP3</mark></code>
            <p>Embora n√£o seja estritamente necess√°rio, √© recomendado o uso de r√≥tulos para identificar as parti√ß√µes para o caso de voc√™ n√£o ter em mente nenhum outro identificador. Caso voc√™ queira especificar o r√≥tulo da parti√ß√£o adicione o argumento <em>-L</em> seguido do "<em>ROTULO</em>" como no exemplo abaixo:</p>
            <code>mkfs.btrfs <em>-L "ROOT"</em> /dev/<mark>storageAP3</mark></code>
        </details>
        <!-- MONTAGEM DE PARTI√á√ïES -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Montar as parti√ß√µes</h2>
        <p>At√© aqui temos o armazenamento particionado e formatado, pronto para a instala√ß√£o do sistema, agora s√≥ √© necess√°rio montar as parti√ß√µes para que elas fiquem acess√≠veis para a instala√ß√£o.</p>
        <p>Montaremos a parti√ß√£o raiz do sistema em <em>/mnt</em>, basta substituir <mark>storageAP4</mark> pelo endere√ßo da parti√ß√£o <em>raiz</em> (<mark>/</mark>) de acordo com o <em>seu</em> sistema:</p>
        <code>mount /dev/<mark>storageAP4</mark> /mnt</code>
        <!-- SUBVOLUMES BTRFS -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <p>Agora criaremos os subvolumes para o BTRFS, primeiro acesse a parti√ß√£o raiz:</p>
        <code>cd /mnt</code>
        <code>E crie os subvolumes um por um com os comandos (fique a vontade para mudar conforme a sua necessidade):</code>
        <code>btrfs subvolume create @<br>btrfs subvolume create @home<br>btrfs subvolume create @snapshots<br>btrfs subvolume create @log<br>btrfs subvolume create @cache<br>btrfs subvolume create @images</code>
        
        <p>Uma vez que os subvolumes est√£o criados retorne para a pasta inicial com o comando cd:</p>
        <code>cd</code>
        <p>Agora vamos desmontar a raiz...</p>
        <code>umount /mnt</code>
        <p>E ent√£o remontaremos a raiz j√° dentro do subvolume <em>@</em>:</p>
        <code>mount -o compress=zstd,noatime,subvol=@ /dev/<mark>storageAP4</mark> /mnt</code>
        <p>Agora criaremos a seguinte estrutura de diret√≥rios (fique a vontade para mudar conforme a sua necessidade)...</p>
<pre><code>./boot
./.snapshots
./var
./var/lib
./var/lib/libvirt
./var/lib/libvirt/images
./var/log
./var/cache
./home
</code></pre>
        <p>...Com este comando:</p>
        <code>mkdir -p /mnt/{boot,home,.snapshots,var/{log,cache,lib/libvirt/images}}</code>
        <p>E agora vamos montar parti√ß√£o por parti√ß√£o:</p>
        <code>mount -o compress=zstd,noatime,subvol=@home /dev/<mark>storageAP3</mark> /mnt/home</code>
        <code>mount -o compress=zstd,noatime,subvol=@snapshots /dev/<mark>storageAP3</mark> /mnt/.snapshots</code>
        <code>mount -o compress=zstd,noatime,subvol=@log /dev/<mark>storageAP3</mark> /mnt/var/log</code>
        <code>mount -o compress=zstd,noatime,subvol=@cache /dev/<mark>storageAP3</mark> /mnt/var/cache</code>
        <code>mount -o compress=zstd,noatime,subvol=@images /dev/<mark>storageAP3</mark> /mnt/var/lib/libvirt/images</code>
        <p>√â importante lembrar que o Fedora ainda utiliza o diret√≥rio <em>/boot/efi</em> para a ESP, ent√£o use os comandos abaixo considerando isso!</p>
        <p>Para montar a XBOOTLDR (considerando que AP1 √© a sua parti√ß√£o XBOOTLDR)</p>
        <code>mount /dev/<mark>storageAP1</mark> /mnt/boot</code>
        <code>mkdir /mnt/boot/efi</code>
        <p>Para montar a ESP (considerando que <mark>storageAP1</mark> √© a sua parti√ß√£o ESP):</p>
        <code>mount /dev/<mark>storageAP1</mark> /mnt/boot/efi</code>
        <p>Para montar a ESP (considerando que <mark>storageAP3</mark> √© a sua parti√ß√£o SWAP):</p>
        <code>swapon /dev/<mark>storageAP3</mark></code>
        <p>Voc√™ pode verificar os pontos de montagem com o comando:</p>
        <code>lsblk</code>
        <p>Para ativar os eventos do UDEV (gerenciador de dispositivos) utilize o comando:</p>
        <code>udevadm trigger</code>
        <p>Para criar a seguinte estrutura de diret√≥rios...</p>
<pre><code>./proc
./dev
./dev/pts
./sys
</code></pre>
        <p>Use o comando:</p>
        <code>mkdir -p /mnt/{proc,sys,dev/pts}</code>
        <p>Agora monte cada um deles com os comandos:</p>
        <code>mount -t proc proc /mnt/proc</code>
        <code>mount -t sysfs sys /mnt/sys</code>
        <code>mount -B /dev /mnt/dev</code>
        <code>mount -t devpts pts /mnt/dev/pts</code>
        <p>Carregue as informa√ß√µes do sistema...</p>
        <code>source /etc/os-release</code>
        <code>export VERSION_ID="$VERSION_ID"</code>
        <p>Caso queira verificar a vers√£o use o comando:</p>
        <code>env | grep -i version</code>
        <!-- PACSTRAP -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <p>Para fazer o que seria relativo ao "pacstrap" do Archlinux e instalar o "core" do sistema use o comando:</p>
        <code>dnf --installroot=/mnt --releasever=$VERSION_ID group install -y core --use-host-config</code>
        <p>Agora vamos instalar o pacote de idiomas em pt-BR:</p>
        <code>dnf --installroot=/mnt install -y glibc-langpack-pt</code>
        <p>Agora vamos usar instalar um script do Arch para facilitar a nossa vida:</p>
        <code>dnf install -y arch-install-scripts</code>
        <p>Vamos gerar a fstab:</p>
        <code>genfstab -U /mnt >> /mnt/etc/fstab</code>
        <p>Caso exista as linhas do /dev/zram no fstab sinta-se a vontade para apag√°-lo.</p>
        <p><strong>Lembre-se:</strong> Copie os arquivos de chave de criptografia para a parti√ß√£o <em>/mnt</em> <strong>ANTES</strong> de prosseguir!</p>
        <code>cp cryptroot.key /mnt/cryptroot.key</code>
        <p>Finalmente vamos ao chroot:</p>
        <code>chroot /mnt /bin/bash</code>
        <p>E remontar as parti√ß√µes:</p>
        <code>mount -a</code>
        <p>E as vari√°veis efi:</p>
        <code>mount -t efivars efivars /sys/firmware/efi/efivars</code>
        <p>E vamos instalar alguns pacotes b√°sicos para prosseguir:</p>
        <code>dnf install -y btrfs-progs efi-filesystem efibootmgr fwupd kernel cryptsetup</code>
        <!-- XBOOTLDR -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Configurando a <em>XBOOTLDR</em></h2>
        <p>Vamos come√ßar copiando o m√≥dulo de kernel Linux para a pasta <em>/boot</em>:</p>
        <code>sudo cp /lib/modules/*/vmlinuz /boot/vmlinuz-$(basename /lib/modules/*)</code>
        <p>Agora vamos configurar o Dracut para gerar o initramfs, j√° que o Dracut espera os keyfiles em <em>/etc/cryptsetup-keys.d/</em>, vamos come√ßar movendo as chaves para esse diret√≥rio:</p>
        <code>mkdir -p /etc/cryptsetup-keys.d</code>
        <code>cp /cryptroot.key /etc/cryptsetup-keys.d/</code>
        <p>Vamos certificar que as chaves est√£o com as permiss√µes corretas:</p>
        <code>chmod 600 /etc/cryptsetup-keys.d/cryptroot.key</code>
        <p>Agora vamos editar o <em>/etc/crypttab</em> (sim, √© a tabela dos dispositivos encriptados):</p>
        <code>nano /etc/crypttab</code>
        <p>E adicione:</p>
        <code>cryptroot /dev/<mark>storageAP4</mark> /etc/cryptsetup-keys.d/cryptroot.key luks</code>
        <p><em>cryptroot</em> √© o nome do mapeamento que vai aparecer em /dev/mapper/cryptroot.</p>
        <p>Agora vamos editar a configura√ß√£o de criptografia do dracut:</p>
        <code>nano /etc/dracut.conf.d/crypt.conf</code>
        <p>E adicione as linhas conforme o exemplo abaixo:</p>
        <code>install_items+=" /etc/cryptsetup-keys.d/cryptroot.key /etc/crypttab "<br>add_dracutmodules+=" crypt "</code>
        <p>O que essa configura√ß√£o faz?</p>
        <ul>
            <li><p>Estamos embutindo o keyfile no initramfs.</p></li>
            <li><p>Incluindo o m√≥dulo para desencripta√ß√£o no initramfs.</p></li>
            <li><p>Incluindo tamb√©m uma tabela e uma chaves para desencripta√ß√£o.</p></li>
        </ul>
        <p>Agora √© s√≥ gerar um novo initramfs:</p>
        <code>dracut -f /boot/initramfs-$(basename /lib/modules/*).img --kver $(basename /lib/modules/*) -v --no-compress</code>
        <p>Caso queira ainda mais seguran√ßa ainda no futuro, depois de embutir as chaves no initramfs, voc√™ pode apagar elas do sistema (em baixo n√≠vel) com o comando:</p>
        <code>shred -u /etc/cryptsetup-keys.d/cryptroot.key</code>
        <!-- SYSTEMD-BOOT -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Instalando systemd-boot</h2>
        <p>Primeiro precisamos do pacote do systemd-boot, instale com o comando:</p>
        <code>dnf install -y systemd-boot-unsigned</code>
        <p>Depois, instale o systemd-boot com o comando abaixo:</p>
        <code>bootctl --esp-path=/boot/efi --boot-path=/boot install</code>
        <p>Agora vamos setar uma entrada como padr√£o para o loader:</p>
        <code>echo "default fedora.conf" >> /boot/loader/loader.conf</code>
        <p>E agora vamos editar essa entrada:</p>
        <code>nano /boot/loader/entries/fedora.conf</code>
        <p>Para iniciar a raiz atrav√©s do subvolume <em>@</em>, voc√™ deve indicar as rootflags como no exemplo abaixo:</p>
        <code>title‚ÄÉFedora<br>linux‚ÄÉ/vmlinuz-linux<br>initrd‚ÄÉ/initramfs-linux.img<br>options root=/dev/storageAP3 <em>rootflags=subvol=@</em> rw quiet</code>
        <p>Ou caso voc√™ tenha usado o LUKS, voc√™ precisa descrever o dispositivo real:dispositivo mapeado, e declarar a raiz no dispositivo mapeado, como no exemplo abaixo:</p>
        <code>options cryptdevice=<em>/dev/<mark>storageAP4</mark>:cryptroot</em>  root=/dev/mapper/<em>cryptroot</em>  rootflags=subvol=@ rw quiet</code>
        <!-- PREPARANDO FIRST-BOOT -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Configurando o firstboot</h2>
        <p>Caso voc√™ queira configurar o ambiente do sistema rec√©m instalado numa tacada s√≥ pode utilizar o comando abaixo:</p>
<code><pre>systemd-firstboot \
--timezone=<em>America/Sao_Paulo</em> \
--hostname=<em>meu_hostname</em> \
--locale=<em>pt_BR.UTF-8</em> \
--keymap=<em>br-abnt2</em> \
--root-password</pre></code>
        <p>Vamos agendar a reetiqueta√ß√£o pelo SELinux:</p>
        <code>fixfiles -F onboot</code>
        <p>E agora voc√™ pode sair do chroot...</p>
        <code>exit</code>
        <p>Desmontar parti√ß√µes...</p>
        <code>umount -n -R /mnt</code>
        <p>E reiniciar o sistema:</p>
        <code>reboot</code>
        <!-- P√ìS INSTALA√á√ÉO -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>P√≥s instala√ß√£o</h2>
        <p>Para criar um novo usu√°rio, com uma pasta em <em>/home</em> e que possa utilizar sudo (por fazer parte do grupo <em>wheel</em>) utilize o comando abaixo substituindo o <mark>seunomedeusu√°rio</mark> pelo nome de usu√°rio que voc√™ deseja:</p>
        <code>useradd -mG wheel seunomedeusu√°rio</code>
        <p>Para configurar a senha da conta desse usu√°rio use o comando abaixo substituindo o <mark>seunomedeusu√°rio</mark> pelo seu nome de usu√°rio:</p>
        <code>passwd seunomedeusu√°rio</code>
        <!-- P√ìS INSTALA√á√ÉO - GRUPOS DE PACOTES -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <p>Caso voc√™ queira continuar com a instala√ß√£o de outros pacotes pode fazer a listagem de grupos de pacotes com o comando:</p>
        <code>dnf group list | less</code>
        <p>Vamos supor que voc√™ queira Instala√ß√£o de ambiente gr√°fico KDE, voc√™ pode fazer isso como no exemplo abaixo:</p>
        <code>dnf group install -y "KDE Plasma Workspaces"</code>
        <p>Agradecimentos ao Stephen's Tech Talks e ao Walian</p>     
    </main>
    <footer id="main-footer">
        <p>Est√° p√°gina ainda est√° em constru√ß√£o üöß</p>
        <a class="footerlink" href="#main-header">‚Üë Retornar ao topo ‚Üë</a>
    </footer>
</body>
</html>
