<!DOCTYPE html>
<html lang="pt-BR" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Aprendendo sobre Secure Boot e TPM e como usar essas tecnologias no Linux.">
    <meta name="keywords" content="formata√ß√£o, windows, linux, freebsd, bios, uefi, instala√ß√£o, balena, etcher, ventoy, os">
    <meta name="author" content="Cain">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Boot & TPM</title>
    <!--Social Media Open Graph-->
    <meta property="og:title" content="Instala√ß√£o de Sistemas Operacionais - Secure Boot"/>
    <meta property="og:url" content="https://cain-dev.github.io/default/"/>
    <meta property="og:type" content="article"/>
    <meta property="og:description" content="Aprendendo sobre Secure Boot e TPM e como usar essas tecnologias no Linux."/>
    <meta property="og:image" content="https://raw.githubusercontent.com/cain-dev/default/main/assets/images/ogimage.jpg"/>
    <!--/Social Media Open Graph-->
    <!--Links-->
    <link rel="shortcut icon" href="https://uefi.org//themes/custom/uefi_d10_olivero/favicon.ico">
    <link rel="stylesheet" type="text/css"href="../os_style.css">   
    <!--/Links-->
</head>
<body>
    <header id="main-header">
        <ul>
            <li><a href="../index.html">Home</a></li>
            <li><p>@cain-dev</p></li>
            <li><a href="../extra/contact.html">Contato</a></li>
        </ul>
    </header>
    <main id="main-area">
        <h1>Secure Boot</h1>
        <!-- INTRODU√á√ÉO -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Introdu√ß√£o</h2>
        <p>Embora eu desconfio bastante dos motivos da Microsoft passar a exigir Secure Boot e TPM2.0 para utiliza√ß√£o do Windows 11, e desconfiar mais ainda de como os fabricantes implementaram essas tecnologias, a verdade √© que as tecnologias em si s√£o bem interessantes e podem garantir a prote√ß√£o para muita dor de cabe√ßa dependendo do seu caso.</p>
        <p>O problema √© que em todo lugar que voc√™ buscar, tanto o Secure Boot quanto o TPM2.0 s√£o descritos apenas como nada mais que "requisitos do Windows 11", e a verdade √© que eles s√£o muito mais que isso, assim como tamb√©m o discurso de "basta atualizar a sua BIOS e manter o Windows 11 atualizado com o Secure Boot ativo" n√£o vale de nada, e se a minha placa m√£e j√° n√£o tem mais suporte? E se eu n√£o utilizar Windows 11? E se essas chaves "originais" forem prejudiciais (sim isso existe, explico mais adiante)? </p>
        <p>A verdade √© que quando voc√™ entende essas tecnologias, esse uso "est√°tico", √© de longe o pior caso! A verdade √© que as chaves usadas no Secure Boot podem ser modificadas, anexadas a outras chaves, removidas, voc√™ mesmo pode at√© criar as suas chaves! E o mesmo serve para o m√≥dulo TPM, voc√™ pode gerar nele as chaves para usar em diversas atividades fora da inicializa√ß√£o do sistema e uma simples trava de disco, eu vou at√© al√©m: Se voc√™ tem um computador mais antigo e n√£o utiliza Windows as chaces s√£o que voc√™ pode se beneficiar de Secure Boot e seu m√≥dulo TPM muito mais do que quem tem computador novo! A menos que queira usar Windows 11...</p>
        <!-- O QUE √â SECURE BOOT -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Ent√£o o que √© Secure Boot?</h2>
        <p>Bom, o Secure Boot pode ser entendido como uma checagem de seguran√ßa pr√©-boot, basicamente, um mecanismo que garante que nenhum execut√°vel seja carregado sem que seja previamente autenticado pelo fabricante do equipamento e/ou o usu√°rio do equipamento e que al√©m disso n√£o esteja listado em nenhuma <i>blacklist</i>, se e somente se o software obedece essas condi√ß√µes ele ser√° inicializado. A genialidade disso √© que mesmo que voc√™ seja infectado com algum c√≥digo muito cabuloso de <i>early-loading</i>, ele simplesmente n√£o ter√° condi√ß√µes de ser carregado. o Secure Boot sozinho (se devidamente configurado) √© mais do que suficiente para impedir a esmagadora maioria dos ransomwares.</p>
        <!-- O QUE √â TPM -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>E o que √© TPM?</h2>
        <p>Para entender o que √© o maldito do TPM primeiro voc√™ precisa entender o que √© Trusted Computing, a Trusted Computing Group √© uma organiza√ß√£o sem fins lucrativos (aham, duvido...) que estabelesce padr√µes de hardware e software para a tal "computa√ß√£o confi√°vel", entenda isso como "como garantir que o computador confie nele mesmo e n√£o em voc√™" (acho que deu pra come√ßar e entender a raz√£o da galera do software livre ser p√© atr√°s com esse tipo de coisa...). TPM, nada mais √© que um m√≥dulo que voc√™ tem na sua placa m√£e (ou que voc√™ adiciona na sua placa m√£e) para usar fun√ß√µes de computa√ß√£o confi√°vel, como por exemplo, a cria√ß√£o e ger√™ncia de chaves de dentro do m√≥dulo, sem a exposi√ß√£o dessas chaves para nenhum outro ambiente. Ou seja: Qualquer que seja a autentica√ß√£o que voc√™ deseja utilizar, a chave ser√° gerada DENTRO do m√≥dulo TPM e ficar√° l√°, e s√≥ vai ser utilizado no processo da autentica√ß√£o.</p>
        <p>Sendo assim, n√£o √© poss√≠vel nem utilizar um keylogger para roubar as chaves para desencriptar algo! A desvantagem √© que isso transforma os ambientes de sistema em ambientes completamente ef√™meros, pois se este m√≥dulo for comprometido de alguma forma, sej√° l√° o que dependa desse m√≥dulo vai ficar sem autentica√ß√£o.</p>
        <p>Ent√£o TPM nada mais √© do que a sigla para <i>Trusted Platform Module</i>, hoje em dia a maioria das placas-m√£e j√° vem com um m√≥dulo desse desde o firmware (tamb√©m chamado de fTPM), e tamb√©m √© importante lembrar que placas-m√£e mais antigas (pr√© intel 99, placas m√£e DDR3) podem ter o m√≥dulo TPM 1.2 adicionado, n√£o √© o mesmo que exigido para o Windows 11 mas ainda assim √© uma op√ß√£o interessante para quem quer fazer uso desse tipo de seguran√ßa.</p>
        <!-- CONTRAS -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Ent√£o se √© t√£o bom assim, n√£o deveriamos usar?</h2>
        <p>Ehhrr... A√≠ que t√°... O conceito da tecnologia em si √© muito bom, por√©m a implementa√ß√£o pode ser BEM porca, e √© bom lembrar que a seguran√ßa para uma plataforma √© t√£o boa quanto a sua implementa√ß√£o, n√£o s√≥ existem casos de chaves de autentica√ß√£o que foram vazadas por fabricantes de componentes, como chaves de teste que foram validadas pelo firmware do aparelho em p√≥s produ√ß√£o para usu√°rio final e at√© mesmo a mera data de expira√ß√£o dessas chaves. O m√≥dulo TPM por si s√≥ √© uma caixa preta que funciona com tipos muito espec√≠ficos de algoritmos e n√£o trabalha s√≥ como um gerador + mem√≥ria, na data que estou escrevendo isso temos os m√≥dulos 1.2 e 2.0, o padr√£o para o m√≥dulo 1.2 tende a rsa2048/sha1 e o famigerado 2.0 rsa2048/sha256... Por mais que o 2.0 permite o uso de curva el√≠ptica mas... N√£o √© o que voc√™ vai achar por a√≠.</p>
        <p>Sem contar que a grande maioria dos fabricantes simplesmente enfiam assinaturas Microsoft goela abaixo, algumas vezes at√© chaves sabidamente explor√°veis, e manuten√ß√£o que √© bom nada, em alguns casos (como nas plataformas ARM) voc√™ pode ser simplesmente impedido de carregar outro sistema ou mesmo <i>brickar</i> o seu dispositivo caso tente mudar as chaves! Ent√£o sim, por mais que √© uma tecnologia que tem bastante potencial elas funcionaram basicamente como um cavalo de tr√≥ia para o usu√°rio final.</p>
        <p>Por√©m, em certas circust√¢ncias, voc√™ pode atualizar a <i>blacklist</i> manualmente, fazendo com que chaves sabidamente exploradas n√£o sejam carregadas, mesmo que a sua placa m√£e j√° n√£o tenha mais atualiza√ß√µes de firmware, voc√™ pode criar as suas chaves, com ou sem o uso de um m√≥dulo TPM, e voc√™ pode at√© mesmo remover todas as chaves usadas nesse processo e usar SOMENTE as SUAS chaves! E √© a√≠ que essa tecnologia brilha, longe de padroniza√ß√£o de fabricantes, longe de implementa√ß√µes est√°ticas, especialmente uso para quem tem computadores mais antigos.</p>
        <!-- MODOS DE OPERA√á√ÉO -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>User mode? Windows mode?</h2>
        <p>√â, eu sei que isso √© confuso mas s√£o coisas diferentes, por√©m √© bem f√°cil de entender a partir do momento que voc√™ consegue separar as coisas. Para o Secure Boot ser implementado para para os par√¢metros do Windows, ele precisa seguir a especifica√ß√£o da Microsoft, ent√£o a sua placa m√£e vai possibilitar dois tipos de "m√©todos" para usar o Secure Boot: O modo "<em>Windows</em>", que segue as especifica√ß√µes da Microsoft, e o modo "<em>OtherOS/Custom</em>", que te da a liberdade de configurar conforme a sua vontade... Ao menos <em>deveria</em> ser assim, mas o que efetivamente ocorre com a esmagadora maioria das implementa√ß√µes √© que o modo "Windows" ativa a checagem de Secure Boot e o modo "OtherOS" ignora a checagem de Secure Boot...</p>
        <p>Independente do modo que escolha, seja <em>Windows</em>, seja <em>OtherOS/Custom</em>, a placa m√£e que suporta Secure Boot vai trabalhar com a inicializa√ß√£o baseado em 2 "correntes" de inicializa√ß√£o: O modo <em>Setup mode</em>, ou seja, o modo pr√©-configura√ß√£o, e o <em>User mode</em>, ou seja, o modo p√≥s-configura√ß√£o, quando o Secure boot est√° devidamente habilitado.</p>
        <p>Resumo:</p>
        <ul>
            <li><p>Windows Mode = Checagem de Secure Boot Ativada;</p></li>
            <li><p>OtherOS Mode = Checagem de Secure Boot Desativada;</p></li>
            <li><p>Setup Mode = As chaves n√£o foram configuradas, o Secure Boot n√£o est√° em funcionamento;</p></li>
            <li><p>User Mode = As chaves foram configuradas, o Secure Boot est√° em funcionamento.</p></li>
        </ul>
        <p>Bem contraintuitivo, eu sei... Essa √© s√≥ uma das diversas controv√©rsias do Secure Boot...</p>
        <h2>Controv√©rsias? Quais controv√©rsias?</h2>
        <p>T√°... Vamos come√ßar pelo b√°sico... Secure Boot √© um termo muito mais comercial do que um termo t√©cnico, o que ele faz √© nada mais nada menos do que uma verifica√ß√£o pr√©-boot, ele n√£o √© a √∫nica ferramenta de verifica√ß√£o pr√©-boot e eu duvido muito que em algum momento ele seja categorizado como a "melhor"... Eu creio que o funcionamento de verifica√ß√£o do Android em dispositivos m√≥veis √© muito mais interessante do que isso.</p>
        <p>Parte do problema est√° n√£o s√≥ no que o Secure Boot √©, mas tamb√©m no que ele <strong>n√£o √©!</strong> Ao ver na BIOS uma op√ß√£o como "Deseja ativar o boot seguro?" Parece que √© uma op√ß√£o que voc√™ ativa e vai ganhar mais "1000 pontos de seguran√ßa", e nada poderia estar mais longe da verdade.</p>
        <p>O Secure Boot, em muitos casos √© desnecess√°rio, redundante, pode ser incoveniente, muitas vezes in√∫til e em alguns casos at√© mesmo <strong>prejudicial</strong> Sim, voc√™ n√£o leu isso errado, mas vamos por partes...</p>
        <p>Quando falamos em Secure Boot, falamos em UEFI, quando falamos em UEFI estamos falando largamente em X86, entendido at√© a√≠? √ìtimo. Ent√£o voc√™ vai instalar o Linux Mint no seu computador, voc√™ baixou a iso e verificou o <em>MD5</em> dessa iso, voc√™ instalou o sistema e usou o sistema apenas com pacotes assinados pela distribui√ß√£o, parab√©ns, voc√™ acabou de fazer o mesmo trabalho que o Secure Boot ia fazer na sua m√°quina... √â s√©rio... </p>
        <p>Parece idiota quando se coloca nesses termos mas √© exatamente a mesma coisa, se voc√™ verificou algo pr√©-boot, voc√™ tem o mesmo benef√≠cio que o Secure Boot pode te proporcionar. As chaves nesses pacotes podem ser t√£o comprometidas quanto as chaves certificadas, na verdade as verifica√ß√µes nos pacotes tendem a ser mais din√¢micas e √∫teis do que aquelas contidas na sua placa m√£e. Esse termo, <i>Secure Boot</i>, passa a impress√£o de que as coisas est√£o MAIS seguras, quando em muitos casos (como esse que acabei de citar), basicamente n√£o h√° ganhos.</p>
        <p>Eu recomendo fortemente que voc√™ leia <a class="link" href="https://github.com/pbatard/rufus/wiki/FAQ#user-content-Why_do_I_need_to_disable_Secure_Boot_to_use_UEFINTFS">aqui</a> o FAQ do conhecid√≠ssimo Rufus, uma das sen√£o a ferramenta mais utilizada para prepara√ß√£o de dispositivos <i>boot√°veis</i>, e como √© dito a√≠ um nome mais preciso para Secure Boot poderia ser  "Imposi√ß√£o da Assinatura do Bootloader", pois √© isso que ele efetivamente faz... No melhor dos casos...</p>
        <p>E voc√™ me pergunta: "Como assim no melhor dos casos?", e eu te respondo de maneira muito f√°cil, imposi√ß√£o de assinaturas n√£o necessariamente, repito: <mark>N√£o necessariamente!</mark> Vai ter influ√™ncia sobre o estado de seguran√ßa da sua plataforma. N√£o ativar o Secure Boot <strong>N√£o significa de forma alguma deixar o seu computador em um estado inseguro!</strong> E isso precisa ser dito.</p>
        <p>A grande verdade √© que a impress√£o comum √© que os motivos dessa imposi√ß√£o feita pela Microsoft aos fabricantes para a padroniza√ß√£o para seus sistemas est√° longe de ser por uma quest√£o de seguran√ßa e muito mais por quest√µes abusivas, quem efetivamente trouxe essa tecnologia foi ela, em meados de lan√ßamento do Windows 8 (salvo engano), e obviamente causou muitas dores de cabe√ßa para quem tentava instalar outros sistemas e at√© mesmo quem tentava reinstalar o Windows nessas m√°quinas. Esse per√≠odo de transi√ß√£o teve uma implementa√ß√£o muito porca, em alguns casos com t√©cnicos pedindo aos fabricantes que "pelo amor de Deus me d√° uma atualiza√ß√£o de BIOS que me permite voltar pro Windows 7".</p>
        <p>Ah, a raz√£o pela qual eu falei que voc√™ tem mais seguran√ßa usando o Secure Boot longe do Windows? √â simples: Windows √© um sistema ub√≠quo quando o assunto √© usu√°rio final comum, por isso os fabricantes tendem a assinar seus produtos com as chaves para esses usu√°rios finais comuns... Se todo mundo, usa as mesmas chaves para validar tudo, logo, se essa entidade certificadora √© comprometida ent√£o a seguran√ßa do Secure Boot tamb√©m √©!</p>
        <p>N√£o meu caro, voc√™ n√£o leu errado: Se 1 - O Secure Boot s√≥ permite iniciar o que cont√©m as chaves reconhecidas e 2 - As chaves da Microsoft sempre s√£o reconhecidas e est√£o em todo lugar, logo 3 - O Secure Boot permite tudo! Ent√£o, se voc√™ conseguir usar o Secure Boot sem as chaves da Microsoft, voc√™ vai ter mais seguran√ßa pelo Secure Boot no Linux que no Windows! Inclusive podendo (como na parte inferior deste guia) voc√™ mesmo assinar o loader do Windows para que inicie sem as chaves Microsoft.</p>
        <p>O problema √© que s√£o grandes as chances que dispositivos na sua m√°quina parem de funcionar, e, dependendo do dispositivo, que o seu computador entre em <i>soft brick</i> ou mesmo <i>hard brick</i>! √â s√©rio! O secure boot n√£o trabalha com "meia autentica√ß√£o", ou todas as chaves s√£o conhecidas e seu sistema vai iniciar, ou alguma chave n√£o √© conhecida e ou n√£o vai iniciar ou pelo menos n√£o vai iniciar o seu dispositivo... Boa sorte se a sua placa de v√≠deo depender de uma chave comprometida...</p>
        <p>Em resumo:</p>
        <ul>
            <li><p>Secure Boot √© antes de mais nada um termo comercial;</p></li>
            <li><p>Ele n√£o necessariamente influencia na seguran√ßa;</p></li>
            <li><p>A impress√£o que passa √© de que os motivos para a Microsoft impor o seu uso n√£o tem nada haver com seguran√ßa;</p></li>
            <li><p>O Secure Boot falhou absurdamente em entregar o prometido;</p></li>
            <li><p>Na esmagadora maioria das vezes, a implementa√ß√£o mais comum dele o torna quase in√∫til;</p></li>
            <li><p>O seu uso pode ser prejudicial, inclusive podendo <i>brickar</i> plataformas.</p></li>
        </ul>
        <p>S√≥ pra fechar esse cap√≠tulo com chave de diamante... Parte dos requisitos de assinatura √© a... Acredite se quiser... <strong>N√£o utiliza√ß√£o de c√≥digo GPLv3!</strong> Voc√™ n√£o leu isso errado, ao mesmo tempo em que existe o Shim para fazer o intercessor entre as chaves Microsoft e o loader do Linux, c√≥digos em GPLv3 n√£o est√£o dentro do escopo para serem assinados... Se isso n√£o √© persegui√ß√£o e abuso eu n√£o sei o que √©.</p>
        <!-- PREPARANDO O SISTEMA -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>E se eu quiser usar isso? Por onde come√ßo?</h2>
        <p>Bom, a minha primeira recomenda√ß√£o √© que voc√™ <mark>salve as configura√ß√µes da sua BIOS!</mark>, a maioria esquece disso e depois vai perder bem um tempo configurando tudo novamente. A segunda coisa a se fazer √© <mark>voltar para as configura√ß√µes de f√°brica da placa m√£e</mark> e, se poss√≠vel <mark>apagar todas as chaves do secure boot</mark> atrav√©s da pr√≥pria placa m√£e. A terceira coisa a se fazer √© (se poss√≠vel) <mark>regravar a √∫ltima vers√£o da bios da sua placa m√£e</mark>, e caso voc√™ tenha comprado um m√≥dulo TPM, <mark>conectar este m√≥dulo na sua placa m√£e</mark>. Por fim <mark>retorne a sua placa m√£e para as configura√ß√µes de f√°brica mais uma vez</mark> e <mark>carregue as chaves padr√£o da sua placa m√£e</mark>, por√©m, sem ativar o modo Windows! (ou seja, sem efetivamente ativar o secure boot).</p>
        <p>Apesar da dor de cabe√ßa, tudo isso vai garantir que voc√™ tenha um ambiente limpo e com chaves v√°lidas (ou t√£o v√°lidas quanto poss√≠vel).</p>
        <h3>Fazendo backup das chaves</h3>
        <p>Ent√£o voc√™ subiu o seu sistema operacional, com as chaves carregadas por√©m sem o secure boot ativo, a primeira coisa a se fazer √© o backup de cada uma dessas chaves usando a ferramenta <em>efi-readvar</em> do pacote <em>efitools</em>.</p>
        <p>Vamos criar os diret√≥rios para come√ßar os trabalhos com o comando:</p>
        <code>mkdir -vp keys/{auth,backup,cfg,esl,ms,oem}</code>
        <p>E agora vamos aos backups das chaves do seu sistema...</p>
        <code>for var in PK KEK db dbx ; do efi-readvar -v $var -o keys/backup/old_${var}.esl; done</code>
        <p>Caso queira fazer manualmente:</p>
        <code>efi-readvar -v PK  -o keys/backup/PK-backup.esl<br>efi-readvar -v KEK -o keys/backup/KEK-backup.esl<br>efi-readvar -v db  -o keys/backup/db-backup.esl<br>efi-readvar -v dbx -o keys/backup/dbx-backup.esl</code>
        <p>Uma vez que voc√™ tem o arquivo de backup dessas chaves, eu recomendo que voc√™ acesse o setup com o comando:</p>
        <code>systemctl reboot --firmware-setup</code>
        <p>E de l√° voc√™ <mark>mais uma vez apague todas as chaves!</mark> N√£o tem como fazer um tutorial para todos os casos, voc√™ vai ter que pegar o manual da sua placa-m√£e e realizar essa tarefa conforme o seu caso espec√≠fico. Assim que o sistema iniciar voc√™ pode verificar se o Secure Boot foi desabilitado com o comando abaixo:</p>
        <code>sudo bootctl status 2>&1 | grep 'Secure Boot'<br>Secure Boot: disabled (setup)</code>
        <!-- M√âTODO SBCTL COM MICROSOFT KEYS -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Eu n√£o tenho paci√™ncia pra isso... S√≥ quero ativar o Secure Boot pra jogar o meu "Vav√°"</h2>
        <section class="alert">
            <p>‚ö†Ô∏è <strong>Alerta!</strong> ‚ö†Ô∏è</p>
            <p>Tenha em mente que em alguns sistemas a utiliza√ß√£o desse m√©todo pode ativar um gatilho autom√°tico para assinatura de kernel! A minha recomenda√ß√£o √© que se voc√™ vai usar esse m√©todo use APENAS ele!</p>
        </section>
        <p>Ok, pro teu caso existe uma ferramenta muito boa chamada <em>sbctl</em>, que automatiza todo o processo de carregamento das chaves, basta usar o comando abaixo para gerar as chaves (que se voc√™ tiver usando algo Arch-based ficar√£o no diret√≥rio <mark>/var/lib/sbctl/keys/</mark>):</p>
        <code>sbctl create-keys</code>
        <p>Depois o comando abaixo para carregar as chaves (junto com as chaves Microsoft):</p>
        <code>sbctl enroll-keys -m</code>
        <details class="spoiler" >
            <summary>Carregar as chaves sem as assinaturas da Microsoft</summary>
            <p><strong>Alerta:</strong> Isso pode <i>brickar</i> o seu dispositivo! S√≥ use esse comando se voc√™ tiver certeza do que est√° fazendo!</p>
            <code>sbctl enroll-keys</code>
            <p>B√¥nus!</p>
            <p>Se voc√™ (for muito do ignorante) estiver usando dual-boot com Windows, voc√™ pode assinar o pr√≥prio bootloader do Windows (<em>bootmgfw.efi</em>) para que o Windows inicie EM secure boot SEM as chaves Microsoft... Isso √© do caralho!  </p>
        </details>
        <p>Agora basta assinar seu bootloader e/ou kernel e/ou unified kernel image ou seja l√° que diabos voc√™ use pra subir o seu sistema üòÇ basta seguir o exemplo abaixo:</p>
        <code>sbctl sign -s /boot/vmlinuz-linux</code>
        <code>sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI</code>
        <!--
        <code>sbctl sign -s -o /boot/vmlinuz-linux.signed /boot/vmlinuz-linux</code>
        <code>sbctl sign -s -o /boot/EFI/BOOT/BOOTX64.EFI.signed /boot/EFI/BOOT/BOOTX64.EFI</code>
        -->
        <p>Depois reiniciar o seu computador, acessar o setup da placa-m√£e, colocar o Secure Boot em modo <mark>Windows</mark> e ser feliz jogando o seu "Vav√°". Ah, e caso queira verificar a validade do Secure Boot voc√™ pode utilizar o comando:</p>
        <code>sbctl status</code>
        <p>E vai o resultado vai ser mais ou menos assim:</p>
<pre><code>Installed: ‚úì sbctl is installed
Owner GUID:	xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
Setup Mode: ‚úì Disabled
Secure Boot: ‚úì Enabled
Vendor Keys: microsoft
</code></pre>
        <!-- M√âTODO AVAN√áADO -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Eu n√£o confio em Microsoft nem fabricante, eu n√£o quero carregar nada que eu n√£o assino, eu quero fazer as minhas chaves!</h2>
        <p>Primeiro: Voc√™ √© dos meus! N√≥s precisamos de mais pessoas assim na computa√ß√£o! Mas pro seu caso... Precisamos antes entender o que diabos s√£o cada uma dessas chaves...</p>
        <h3>PK</h3>
        <p>Basicamente a "<i>masterkey</i>" do processo de Secure Boot, basicamente a chave de autoridade m√°xima da plataforma: Essa chave que autoriza toda e qualquer modifica√ß√£o nas chaves subsequentes. √â como se essa chave fosse o <i>handshake</i> entre o propriet√°rio da plataforma e o firmware da plataforma.</p>
        <h3>noPK</h3>
        <p>N√£o √© oficialmente um tipo de chave, algumas vezes chamada de <i>reset key</i>, nada mais √© do que um arquivo vazio assinado com a <em>Platform Key (PK)</em>, que por ser um arquivo devidamente assinado, quando carregado ele efetivamente apaga o conte√∫do da <em>PK</em>, desativando assim o Secure Boot. √â um recurso bastante engenhoso.</p>
        <h3>KEK (Key Exchange Key)</h3>
        <p>Se a PK Key atua como o <i>handshake</i> entre o propriet√°rio da plataforma e o firmware da plataforma, essa chave atua como o <i>handshake</i> entre o firmware e o sistema operacional. Se a chave PK √© a <i>masterkey</i>, a chave KEK √© como uma simples chave de acesso que valida as altera√ß√µes do sistema para o firmware (como nas chaves <em>DB/DBX</em>) sem comprometer a autoridade maior naquela plataforma.</p>
        <h3>DB (Signature Database)</h3>
        <p>Em resumo, essa chave cont√©m as assinaturas dos softwares <em>confi√°veis</em>.</p>
        <h3>DBX (Revoked Signature Database)</h3>
        <p>Em resumo, essa chave cont√©m as assinaturas dos softwares <em>n√£o</em>-confi√°veis. √â interessante ressaltar que o <em>uefi.org</em> mant√©m um bin√°rio com uma lista p√∫blica de chaves revogadas, voc√™ pode acessar essa lista atrav√©s <a class="link" href="https://uefi.org/revocationlistfile">desse link</a>.</p>
        <p>E quanto a hierarquia de autentica√ß√£o √© simples: As chaves PK (ou seja, a masterkey, que s√£o √∫nicas) assinam os certificados PK, noPK e KEK. As chaves KEK (que podem ser mais de uma) por sua vez assinam o DB e o DBX, por fim o DB assina os execut√°veis confi√°veis.</p>
        <h3>E quanto a MOK Key?</h3>
        <p>Ehhrr... Ent√£o... Lembra das cr√≠ticas ao Secure Boot a√≠ acima? A MOK Key n√£o existe como parte da especifica√ß√£o do Secure Boot. Eu explico...</p>
        <p>Devido a quest√£o falada sobre a ubiquidade do Windows e da quantidade de coisas que se escoram nessas assinaturas, foi criado um mini-bootloader de primeiro est√°gio chamado Shim (que vou me segurar muito pra n√£o chamar de gambiarra...), que √© assinado com uma dessas chaves e permite ao usu√°rio criar as suas <em>Machine Owner Keys</em> (ou <em>MOK Keys</em>), e ent√£o o usu√°rio pode criar as suas chaves, assinar os seus execut√°veis e inserir essas chaves "dentro do Shim" para que ele fa√ßa o <i>handshake</i> para possibilitar a inicializa√ß√£o dos seus (usu√°rio) execut√°veis...</p>
        <p>Se voc√™ for no site do Debiam, por exemplo, vai encontrar um <i>disclaimer</i> sobre como o <i>"Secure Boot n√£o √© uma tentativa de obstruir o mercado"</i>, que <i>"A Microsoft age como intermedi√°ria para certificar as organiza√ß√µes autorizadas"</i> e sobre como <i>"os usu√°rios podem inserir as suas chaves, e alguns usu√°rios podem at√© mesmo for√ßar o firmware a reconhecer apenas chaves de usu√°rio"</i>... O ponto √©: Eu entendo a Microsoft, como parte da ponta de lan√ßa do projeto, ter participa√ß√£o na padroniza√ß√£o dessa tecnologia. Eu entendo Microsoft ser uma das autoridades que podem emitir esse tipo de certificado... Mas n√£o estamos falando de chaves da Canonical, Debian e Red Hat j√° presentes na placa m√£e e mecanismos de adi√ß√£o de chaves de usu√°rio diretamente desde o firmware, estamos falando de um bootloader criado como vetor para lidar com as chaves do usu√°rio de dentro de um sistema Linux!</p>
        <p>Eu entendo a Asus ter a chave <em>Platform Key</em> em suas placas m√£e, e j√° ter nos bancos de dado chaves permissivas para Red Hat, Canonical ou Debian e at√© mesmo da Microsoft... Mas a necessidade de um bootloader assinado pela Microsoft que vai ent√£o carregar as minhas chaves √© um cuspe na minha cara!</p>
        <p>Perceba: Eu n√£o estou dizendo que o Shim n√£o √© uma boa ferramenta, isso ele √©! Eu n√£o estou dizendo que para alguns Setups ele n√£o √© uma boa alternativa, isso ele tamb√©m √©, mas, se a Microsoft tem poder para exigir o reconhecimento das suas assinaturas diretamente nas placas m√£es ela tamb√©m tem poder para colocar ao menos Red Hat, Canonical, Debian e at√© mesmo uma chave para o FreeBSD no mesmo barco, ou n√£o?</p>
        <p>Ent√£o isso √© a MOK key: √â uma chave de usu√°rio, que voc√™ insere numa lista de chaves confi√°veis de um mini-bootloader, para que esse permita as aplica√ß√µes assinadas por voc√™.</p>
        <h2>Gerando as chaves</h2>
        <!-- M√âTODO AVAN√áADO - CHAVE PK -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <p>Para gerar as chaves tenha de refer√™ncia os comandos abaixo:</p>
        <h3>PK</h3>
        <code>openssl req -new -x509 -newkey rsa:2048 -subj "/CN=Private PK" -keyout PK.key -out PK.crt -days 3650 -sha256</code>          
        <h3>KEK</h3>
        <code>openssl req -new -x509 -newkey rsa:2048 -subj "/CN=Private KEK" -keyout KEK.key -out KEK.crt -days 3650 -sha256 </code>
        <h3>DB</h3>
        <code>openssl req -new -x509 -newkey rsa:2048 -subj "/CN=Private db" -keyout db.key -out db.crt -days 3650 -sha256</code>
        <p>Por padr√£o se usa <em>rsa:2048</em> com <em>sha256</em> com <em>3650</em> dias (basicamente 10 anos), mas fique a vontade para testar conforme sua necessidade como usar <em>rsa:4096</em> para mais seguran√ßa ou <em>sha1</em> para especifica√ß√µes mais antigas, de qualquer modo lembre-se de que deve ser compat√≠vel com as especifica√ß√µes da sua plataforma!</p>
        <details class="spoiler" >
            <summary>Usando config files</summary>
            <p>Lembrando tamb√©m que o argumento <em>-subj</em> pode receber mais par√¢metros conforme a sua necessidade, por exemplo:</p>
            <code>openssl req -new -key chave_privada.pem -subj "/C=BR/ST=S√£o Paulo/L=S√£o Paulo/O=Minha Empresa/OU=Departamento de TI/CN=meusite.com/emailAddress=contato@meusite.com/GN=Jo√£o/SN=Silva/UID=joaozinho" -out pedido.csr</code>
            <ul>
                <li><p>C=BR, o par√¢metro <em>Country</em> recebe o identificador de pa√≠s, nesse caso Brasil.</p></li>
                <li><p>ST=S√£o Paulo, o par√¢metro <em>State</em> recebe o identificador de estado ou prov√≠ncia, nesse caso S√£o Paulo.</p></li>
                <li><p>L=S√£o Paulo, o par√¢metro <em>Locality</em> recebe o identificador de cidade ou regi√£o, nesse caso S√£o Paulo.</p></li>
                <li><p>O=Minha Empresa, o par√¢metro <em>Organization</em> recebe o identificador de organiza√ß√£o ou empresa, nesse caso Minha Empresa.</p></li>
                <li><p>OU=Departamento de TI, o par√¢metro <em>Organization Unit</em> recebe o identificador de unidade ou departamento da organiza√ß√£o ou empresa, nesse caso Departamento de TI.</p></li>
                <li><p>CN=meusite.com, o par√¢metro <em>Common name</em> recebe o de nome comum, que pode ser um identificador geral ou de dom√≠nio, nesse caso meusite.com.</p></li>
                <li><p>emailAddress=contato@meusite.com, o par√¢metro <em>emailAddress</em> recebe o endere√ßo de email, nesse caso contato@meusite.com.</p></li>
                <li><p>GN=Jo√£o, o par√¢metro <em>Given name</em> recebe o nome pr√≥prio, nesse caso Jo√£o.</p></li>
                <li><p>SN=Silva, o par√¢metro <em>Surname</em> recebe o sobrenome, nesse caso Silva.</p></li>
                <li><p>UID=joaozinho, o par√¢metro <em>User ID</em> recebe o identificador de usu√°rio, nesse caso joaozinho.</p></li>
            </ul>
            <p>Voc√™ tamb√©m pode gerar essa chave atrav√©s de um config file como no exemplo abaixo:</p>
            <code>nano keys/cfg/PK.cfg</code>
<pre><code>
[ req ]
default_bits         = <em>4096</em>
encrypt_key          = no
string_mask          = utf8only
utf8                 = yes
prompt               = no
distinguished_name   = req_distinguished_name
x509_extensions      = my_x509_exts
    
[ req_distinguished_name ]
countryName             = <em>BR</em>
stateOrProvinceName     = <em>S√£o Paulo</em>
localityName            = <em>S√£o Paulo</em>
organizationName        = <em>Minha Empresa</em>
organizationalUnitName  = <em>Departamento de TI</em>
commonName              = <em>meusite.com Platform Key</em>
emailAddress            = <em>contato@meusite.com</em>
givenName               = <em>Jo√£o</em>
surname                 = <em>Silva</em>
userId                  = <em>joaozinho</em>

<!--
[ req_distinguished_name ]
C                    = BR
ST                   = S√£o Paulo
L                    = S√£o Paulo
O                    = Minha Empresa
OU                   = Departamento de TI
CN                   = meusite.com
emailAddress         = contato@meusite.com
GN                   = Jo√£o
SN                   = Silva
UID                  = joaozinho
-->
    
[ my_x509_exts ]
keyUsage             = digitalSignature
extendedKeyUsage     = codeSigning
basicConstraints     = critical,CA:FALSE
subjectKeyIdentifier = hash
</code></pre>
            <p>Lembre-se de n√£o usar <em>-subj</em> quando for fazer a chave atrav√©s de um arquivo de configura√ß√£o, pois qualquer par√¢metro passado para esse argumento vai sobreescrever os par√¢metros dados pelo arquivo.</p>
            <code>openssl req -x509 -sha256 -days 3650 -outform PEM -config keys/cfg/PK.cfg -keyout keys/PK.key -out keys/PK.pem</code>
            <p>Voc√™ pode verificar a chave com:</p>
            <code>openssl x509 -text -noout -inform PEM -in keys/PK.pem</code>
            <p>Agora vamos copiar este arquivo como KEK.cfg:</p>
            <code>cp -v keys/cfg/{PK,KEK}.cfg</code>
            <p>E vamos editar o par√¢metro <em>Platform Key</em> para <em>Key Exchange Key</em>:</p>
            <code>sed -i 's/Platform Key/Key Exchange Key/g' /keys/cfg/KEK.cfg</code>
            <p>E gerar as chaves agora usando o <em>KEK.cfg</em>:</p>
            <code>openssl req -x509 -sha256 -days 3650 -outform PEM -config keys/cfg/KEK.cfg -keyout keys/KEK.key -out keys/KEK.pem</code>
            <p>Confira com:</p>
            <code>openssl x509 -text -noout -inform PEM -in keys/KEK.pem</code>
            <p>Mesmo esquema para o <em>db.cfg</em>, primeiro copiar o arquivo:</p>
            <code>cp -v keys/cfg/{PK,db}.cfg</code>
            <p>Depois alterar o commonName:</p>
            <code>sed -i 's/Platform Key/Signature Database/g' keys/cfg/db.cfg</code>
            <p>Gerar a chave:</p>
            <code>openssl req -x509 -sha256 -days 3650 -outform PEM -config keys/cfg/db.cfg -keyout keys/db.key -out keys/db.pem</code>
            <p>E depois verificar a chave:</p>
            <code>openssl x509 -text -noout -inform PEM -in keys/db.pem</code>
        </details>
        <h2>Por que n√£o estamos criando chaves DBX?</h2>
        <p>Pelo fato de DBX ser uma lista de revoga√ß√£o de hashes sabidamente maliciosos, expirados ou revogados, o interessante √© adicionar o m√°ximo de assinaturas revogadas poss√≠vel, de prefer√™ncia extendendo as chaves que j√° vieram na sua placa m√£e com listas de revoga√ß√µes mais novas, jamais tenha uma chave DBX nova.</p>
        <!-- M√âTODO AVAN√áADO - GERAR UUID -->
        <!-- ///////////////////////////////////////////////////////////////////////////////////////////////-->
        <h2>Converter para formato AUTH</h2>
        <p>Agora com as chaves devidamente criadas precisamos gerar um identificador √∫nico para converter os certificados para o formato <em>AUTH</em> , para isso use o comando:</p>
        <!--
        <code>uuidgen > uuid.txt</code>
        -->
        <code>echo "$(uuidgen -r)" > keys/guid.txt</code>
        <p>Para verificar o c√≥digo gerado use o comando:</p>
        <code>cat keys/guid.txt</code>
        <p>Vai retornar uma como a do exemplo abaixo:</p>
        <code>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</code>
        <h3>Gerando PK ESL</h3>
        <code>cert-to-efi-sig-list -g "$(< keys/guid.txt)" keys/PK.pem keys/esl/PK.esl</code>
        <h3>Gerando PK AUTH</h3>
        <code>sign-efi-sig-list -g "$(< keys/guid.txt)" -t "$(date +'%F %T')" -c keys/PK.pem -k keys/PK.key PK keys/esl/PK.esl keys/auth/PK.auth</code>
        <!--    
        <code>sign-efi-sig-list -g "$(< keys/guid.txt)" -t "$(date +'%d-%m-%Y %H-%M-%S')" -c keys/PK.pem -k keys/PK.key PK keys/esl/PK.esl keys/auth/PK.auth</code>
        -->
        <h3>Gerando KEK ESL</h3>
        <code>cert-to-efi-sig-list -g "$(< keys/guid.txt)" keys/KEK.pem keys/esl/KEK.esl</code>
        <h3>Gerando KEK AUTH</h3>
        <code>sign-efi-sig-list -g "$(< keys/guid.txt)" -t "$(date +'%F %T')" -c keys/PK.pem -k keys/PK.key KEK keys/esl/KEK.esl keys/auth/KEK.auth</code>
        <h3>Gerando DB ESL</h3>
        <code>cert-to-efi-sig-list -g "$(< keys/guid.txt)" keys/db.pem keys/esl/db.esl</code>
        <h3>Gerando DB AUTH</h3>
        <code>sign-efi-sig-list -g "$(< keys/guid.txt)" -t "$(date +'%F %T')" -c keys/KEK.pem -k keys/KEK.key db keys/esl/db.esl keys/auth/db.auth</code> 
        <h3>Gerando noPK ESL (opcional)</h3>
        <code>touch keys/esl/noPK.esl</code>
        <h3>Gerando noPK AUTH (opcional)</h3>
        <code>sign-efi-sig-list -g "$(< keys/guid.txt)" -t "$(date +'%F %T')" -c keys/PK.pem -k keys/PK.key PK keys/esl/noPK.esl keys/auth/noPK.auth</code>        
        <h2>Instalando as chaves (presumindo que voc√™ est√° em Setup Mode)</h2>
        <h3>DBX</h3>
        <code>sudo efi-updatevar -f dbx.auth dbx</code>
        <h3>DB</h3>
        <code>sudo efi-updatevar -f db.auth db</code>
        <h3>KEK</h3>
        <code>sudo efi-updatevar -f KEK.auth KEK</code>
        <h3>PK</h3>
        <code>sudo efi-updatevar -f PK.auth PK</code>
        <p>A execu√ß√£o bem-sucedida desse comando finaliza o <em>Setup mode</em> e deixa o Secure Boot em <em>User mode</em>.</p>
        <p>Para verificar se as chaves foram devidamente incorporadas voc√™ pode usar o comando:</p>
        <code>efi-readvar</code>
        <h2>Como assinar m√≥dulos?</h2>
        <p>Aqui √© um exemplo de como assinar o Kernel usando as chaves <em>db</em>:</p>
        <code>sbsign --key keys/db.key --cert keys/db.pem --output /boot/vmlinuz.signed /boot/vmlinuz</code>
        <h2>Retornando para Setup Mode</h2>
        <code>sudo efi-updatevar -f noPK.auth PK</code>
        <p>Como foi dito acima a execu√ß√£o bem-sucedida desse comando efetivamente apaga o conte√∫do da PK, desativando assim o Secure Boot.</p>
        <h2>Caso queira apagar as vari√°veis:</h2>
        <h3>DBX</h3>
        <code>sudo efi-updatevar -d dbx</code>
        <h3>DB</h3>
        <code>sudo efi-updatevar -d db</code>
        <h3>KEK</h3>
        <code>sudo efi-updatevar -d KEK</code>
        <h3>PK</h3>
        <code>sudo efi-updatevar -d PK</code>

        
        


        <!--
        <h3>Overview</h3>
        <p>Para ver quem √© dono da chave</p>
        <code>efi-readvar -v PK</code>
        <p>Para ver a chave p√∫blica</p>
        <code>mokutil --pk</code>
        <p>Para ver quem √© dono da chave</p>
        <code>efi-readvar -v KEK</code>
        <p>Para ver a chave p√∫blica</p>
        <code>mokutil --kek</code>
        <p>Para ver quem √© dono da chave</p>
        <code>efi-readvar -v db</code>
        <p>Para ver a chave p√∫blica</p>
        <code>mokutil --db</code>
        <p>Para ver quem √© dono da chave</p>
        <code>efi-readvar -v dbx</code>
        <p>Para ver a chave p√∫blica</p>
        <code>mokutil --dbx</code>
        <h3>Backup das chaves</h3>
        <code>mkdir -vp keys/{auth,bak,cfg,esl,ms,oem}</code>
        -->



        <!--
        
        <aside>
            <p>Nota:</p>
            <p>Voc√™ n√£o deveria estar vendo isso!</p>
        </aside>

        -->

    </main>
    <footer id="main-footer">
        <p>Est√° p√°gina ainda est√° em constru√ß√£o üöß</p>
        <a class="footerlink" href="#main-header">‚Üë Retornar ao topo ‚Üë</a>
    </footer>
</body>
</html>
